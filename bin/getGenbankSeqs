#!/usr/bin/env python

import transMapProgSetup  # noqa: F401
import sqlite3
import argparse
from transMap.genomeDefs import AnnSetType
from transMap.transMapLite import SourceDbTables, getTransMapSrcAccs
from pycbio.sys import fileOps
from pycbio.hgdata.hgLite import SequenceLite
import pipettor

verbose = False


def parseArgs():
    desc = """Obtain RNA sequence file for UCSC GenBank alignments.
    """
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("--verbose", action="store_true", default=False,
                        help="""verbose tracing""")
    parser.add_argument("srcHgDbName",
                        help="""Genome database for assembly""")
    parser.add_argument("annSetType", choices=(AnnSetType.mrna, AnnSetType.splicedEst, AnnSetType.refSeq), type=AnnSetType,
                        help="""annotation set type to obtain""")
    parser.add_argument("transMapSrcDb",
                        help="""sqlite3 database for source dataset; must have srcAligns table loaded with alignments""")
    return parser.parse_args()


def getTransMapSrcAccsFile(annSetType, srcDbConn):
    tmpAccFile = fileOps.tmpFileGet("transMap.{}.".format(annSetType), ".acc")
    accVers = getTransMapSrcAccs(srcDbConn)
    with open(tmpAccFile, "w") as fh:
        for accVer in accVers:
            fh.write("{}\n".format(accVer))
    return tmpAccFile


def getSeqFasta(srcHgDbName, annSetType, seqAccFile):
    "get fasta file"
    seqFa = fileOps.tmpFileGet("transMap.{}.".format(annSetType), ".fa")
    getRnaCmd = ("getRna", "-inclVer", "hgFixed", seqAccFile, "/dev/stdout")
    srcDbCmd = ("awk", "-v", "srcDb={}".format(srcHgDbName),
                '''/^>/{$0 = ">" srcDb ":" substr($0, 2)} {print $0}''')
    cmds = [getRnaCmd, srcDbCmd]
    pipettor.run(cmds, stdout=seqFa)
    return seqFa


def loadSeqFa(seqFa, srcDbConn):
    seqTbl = SequenceLite(srcDbConn, SourceDbTables.srcSeqTbl, True)
    seqTbl.loadFastaFile(seqFa)
    seqTbl.index()


def getGenbankSeqs(srcHgDbName, annSetType, transMapSrcDb):
    srcDbConn = sqlite3.connect(transMapSrcDb)
    tmpAccFile = getTransMapSrcAccsFile(annSetType, srcDbConn)
    seqFa = getSeqFasta(srcHgDbName, annSetType, tmpAccFile)
    loadSeqFa(seqFa, srcDbConn)
    srcDbConn.close()
    fileOps.rmFiles(tmpAccFile, seqFa)

# entry
opts = parseArgs()
getGenbankSeqs(opts.srcHgDbName, opts.annSetType, opts.transMapSrcDb)
