#!/usr/bin/env python

import transMapProgSetup  # noqa: F401
import argparse
import sqlite3
from transMap.genomeDefs import AnnSetType
from transMap.transMapLite import SourceDbTables, loadSrcGeneMetaData
from transMap import alignIdToSrcId, srcIdToAccv, accVerToAcc
from transMap.genbank import GenbankHgData
from pycbio.hgdata import hgLite

verbose = False


def parseArgs():
    desc = """Obtain metadata for UCSC GenBank alignments.
    """
    parser = argparse.ArgumentParser(description=desc)
    parser.add_argument("--verbose", action="store_true", default=False,
                        help="""verbose tracing""")
    parser.add_argument("--testLimit", action="store_true", default=False,
                        help="""limit to alignments that are in srcAligns table for testing""")
    parser.add_argument("srcHgDb",
                        help="""Genome database for assembly""")
    parser.add_argument("annSetType", choices=(AnnSetType.mrna, AnnSetType.refSeq), type=AnnSetType,
                        help="""annotation set type to obtain""")
    parser.add_argument("transMapSrcDb",
                        help="""sqlite3 database for source dataset; must have srcAligns table loaded with alignments""")
    opts = parser.parse_args()
    global verbose
    verbose = opts.verbose
    return opts


def getTestLimitAccvList(transMapSrcDbConn):
    """get test subset that was loaded"""
    srcAlignsTbl = hgLite.PslLite(transMapSrcDbConn, SourceDbTables.srcAlignsTbl)
    sql = """SELECT qName FROM {table};"""
    return list(set([accVerToAcc(srcIdToAccv(alignIdToSrcId(row[0])))
                     for row in srcAlignsTbl.query(sql)]))


def getGenbankMetaData(srcHgDb, annSetType, transMapSrcDb, testLimit):
    genbankHgData = GenbankHgData(srcHgDb, annSetType)
    transMapSrcDbConn = sqlite3.connect(transMapSrcDb)
    try:
        testAccvSubset = getTestLimitAccvList(transMapSrcDbConn) if testLimit else None
        metaDataReader = genbankHgData.metaDataReader(testAccvSubset)
        loadSrcGeneMetaData(transMapSrcDbConn, metaDataReader)
    finally:
        transMapSrcDbConn.close()

opts = parseArgs()
getGenbankMetaData(opts.srcHgDb, opts.annSetType, opts.transMapSrcDb, opts.testLimit)
