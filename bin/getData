#!/usr/bin/env python

import sys, os
rootDir = os.path.normpath(os.path.dirname(os.path.dirname(sys.argv[0])))
sys.path.extend((rootDir+"/extern/pycbio/lib", rootDir+"/lib/py", rootDir+"/rules"))
from transMap import TransMap,GenomeDefs, setup
from pycbio.exrun import ExRun, Verb
from pycbio.sys import fileOps, procOps
from optparse import OptionParser
import CDnaData

class CmdLine(object):
    usage="""%prog [options] genomeDefsPickle mappingsInfo"""
    def __init__(self):
        parser = OptionParser(usage=CmdLine.usage)
        setup.addParseOpts(parser)
        (opts, args) = parser.parse_args()
        if len(args) != 2:
            parser.error("wrong number of arguments")
        (self.genomeDefsPickle, self. mappingsInfo) = args
        self.__dict__.update(opts.__dict__)


def dumpMappings(infoFile, mappings, allMappings):
    fh = open(infoFile, "w")
    for chains in allMappings:
        fh.write(str(chains))
        if chains not in mappings.chainsMap:
            fh.write("\tSKIPPED:")
            if chains.orient == GenomeDefs.ChainOrient.rev:
                fh.write(" reverse")
            if not chains.haveChainFile():
                fh.write(" noChains")
            if not chains.haveNetFile():
                fh.write(" noNets")
        fh.write('\n')
    fh.close()

# entry
opts = CmdLine()

(genomeDefs, mappings) = setup.mkMappingDefs(opts)

# so we can warn about missing
allMappings = genomeDefs.getMappingSets(onlyDestDbs=opts.onlyDestDbs,
                                        otherDestDbs=opts.otherDestDbs, 
                                        clades=opts.clades,
                                        skipDbs=opts.skipDbs,
                                        inclMissingChains=True,
                                        inclRevChains=True)
dumpMappings(opts.mappingsInfo, mappings, allMappings)

exrun = ExRun()
exrun.verb.flags.add(Verb.details)
transMap = TransMap.TransMap(exrun, genomeDefs, ".", mappings)
for srcDb in mappings.srcDbs:
    CDnaData.createRules(transMap, srcDb)
exrun.run()
