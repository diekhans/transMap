#!/usr/bin/env python
import sys, os
rootDir = os.path.normpath(os.path.dirname(os.path.dirname(sys.argv[0])))
sys.path.append(rootDir+"/extern/pycbio/lib")
from optparse import OptionParser
from pycbio.hgdata.psl import PslReader
from pycbio.sys import fileOps

class CmdLine(object):
    usage="""%prog [options] psl1 [psl2 ...]

    convert source psl files to the transMapSrc table format
"""
    def __init__(self):
        parser = OptionParser(usage=CmdLine.usage)
        parser.add_option("--srcDb", action="store", dest="srcDb", default=None,
                          help="""use this srcDb rather than parsing from psl path""")
        (opts, args) = parser.parse_args()
        if len(args) < 1:
            parser.error("wrong number of arguments")
        self.psls = args
        self.__dict__.update(opts.__dict__)

def parseSrcDb(fpath):
    return fpath.split("/")[-2]

def pslCnv(pslFile, srcDb, outFh):
    if srcDb == None:
        srcDb = parseSrcDb(pslFile)
    for psl in PslReader(pslFile):
        fileOps.prRowv(outFh, srcDb, psl.qName, psl.tName, psl.tStart, psl.tEnd, psl.strand,
                       ("%0.3f" % psl.identity()), ("%0.3f" % psl.queryAligned()))

opts = CmdLine()
for psl in opts.psls:
    pslCnv(psl, opts.srcDb, sys.stdout)
